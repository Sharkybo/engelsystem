---
- name: Reload nginx
  systemd:
    daemon_reload: yes
    name: nginx.service
    state: reloaded
  listen: Reload nginx

- name: Grant nginx read access
  file:
    path: /opt/engelsystem
    mode: u=rwX,g=rwX,o=rX
    owner: root
    group: root
    recurse: yes
  listen: Engelsystem updated

- name: Grant nginx write access to '/import'
  file:
    path: /opt/engelsystem/import
    mode: u=rwX,g=rwX,o=rX
    owner: root
    group: www-data
    recurse: yes
  listen: Engelsystem updated

- name: Create engelsystem database
  mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    name: engelsystem
    state: present
  listen: Engelsystem updated

- name: Install database
  shell: cat /opt/engelsystem/db/install.sql /opt/engelsystem/db/update.sql | mysql -B engelsystem
  listen: Engelsystem updated

- name: Create engelsystem user
  mysql_user:
    name: engelsystem
    password: engelsystem
    priv: engelsystem.*:ALL,GRANT
    login_unix_socket: /var/run/mysqld/mysqld.sock
  listen: Engelsystem updated
